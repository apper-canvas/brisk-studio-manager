import apper from "https://cdn.apper.io/actions/apper-actions.js";

export default apper.serve(async (req) => {
  try {
    // Only allow POST requests
    if (req.method !== 'POST') {
      return new Response(
        JSON.stringify({ success: false, error: 'Method not allowed' }),
        { status: 405, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Get CLIPDROP API key from secrets
    const apiKey = await apper.getSecret('CLIPDROP_API_KEY');
    if (!apiKey) {
      return new Response(
        JSON.stringify({ success: false, error: 'CLIPDROP API key not configured' }),
        { status: 500, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Parse request body
    let requestData;
    try {
      requestData = await req.json();
    } catch (error) {
      return new Response(
        JSON.stringify({ success: false, error: 'Invalid JSON in request body' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Validate required fields
    const { prompt, width = 1024, height = 1024 } = requestData;
    
    if (!prompt || typeof prompt !== 'string' || prompt.trim().length === 0) {
      return new Response(
        JSON.stringify({ success: false, error: 'Prompt is required and must be a non-empty string' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Validate prompt length
    if (prompt.length > 1000) {
      return new Response(
        JSON.stringify({ success: false, error: 'Prompt must be less than 1000 characters' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Validate dimensions
    const validSizes = [256, 512, 768, 1024];
    if (!validSizes.includes(width) || !validSizes.includes(height)) {
      return new Response(
        JSON.stringify({ 
          success: false, 
          error: `Invalid dimensions. Width and height must be one of: ${validSizes.join(', ')}` 
        }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Prepare FormData for CLIPDROP API
    const formData = new FormData();
    formData.append('prompt', prompt.trim());
    
    // Make request to CLIPDROP API
    let clipdropResponse;
    try {
      clipdropResponse = await fetch('https://clipdrop-api.co/text-to-image/v1', {
        method: 'POST',
        headers: {
          'x-api-key': apiKey,
        },
        body: formData
      });
    } catch (fetchError) {
      return new Response(
        JSON.stringify({ 
          success: false, 
          error: 'Failed to connect to CLIPDROP API',
          details: fetchError.message 
        }),
        { status: 502, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Handle CLIPDROP API response
    if (!clipdropResponse.ok) {
      let errorMessage = 'CLIPDROP API request failed';
      try {
        const errorText = await clipdropResponse.text();
        errorMessage = errorText || errorMessage;
      } catch (parseError) {
        errorMessage = `HTTP ${clipdropResponse.status}: ${clipdropResponse.statusText}`;
      }

      const statusCode = clipdropResponse.status === 429 ? 429 : 
                        clipdropResponse.status === 401 ? 401 :
                        clipdropResponse.status === 403 ? 403 : 502;

      return new Response(
        JSON.stringify({ 
          success: false, 
          error: errorMessage,
          statusCode: clipdropResponse.status
        }),
        { status: statusCode, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Get image data as array buffer
    let imageBuffer;
    try {
      imageBuffer = await clipdropResponse.arrayBuffer();
    } catch (error) {
      return new Response(
        JSON.stringify({ 
          success: false, 
          error: 'Failed to process image data from CLIPDROP API' 
        }),
        { status: 502, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Convert to base64 for JSON response
    const imageBase64 = btoa(String.fromCharCode(...new Uint8Array(imageBuffer)));
    
    if (!imageBase64) {
      return new Response(
        JSON.stringify({ 
          success: false, 
          error: 'No image generated by CLIPDROP API' 
        }),
        { status: 502, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Return successful response
    return new Response(
      JSON.stringify({
        success: true,
        data: {
          image: `data:image/png;base64,${imageBase64}`,
          prompt: prompt.trim(),
          width: width,
          height: height,
          timestamp: new Date().toISOString()
        }
      }),
      { 
        status: 200, 
        headers: { 'Content-Type': 'application/json' } 
      }
    );

  } catch (error) {
    return new Response(
      JSON.stringify({ 
        success: false, 
        error: 'Internal server error',
        details: error.message 
      }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    );
  }
});